All Subset Regression Cox
================
Santiago Boh√≥rquez
7 de junio de 2016

All subsets variable selection for Cox Model
--------------------------------------------

*stream of consciousness for now*

First try to program as if it was for a package:

First, set up the environment

``` r
setwd("D:/Desktop/RM/Programs")
rm(list=ls(all=TRUE))

memory.limit(size=20000)

library(survival)
library(MASS)
```

What I want to do is estimate Mallows \(C_p\), using Kuk (1984) procedure \[*need citation*\] \(\Lambda^{'}_{\alpha}=W^{'}_{\alpha}+2p_{\alpha}\) for all subset regressions, where \(W^{'}_{\alpha}=\hat{\beta}_{2}C^{-1}_{22}\hat{\beta}_{2}\) and \(C=I^{-1}\), and \(\beta_2\) are the restricted coefficients.And \(C_{p_{\alpha}}=\Lambda^{'}_{\alpha} - (p-1)\). The function `Cp` does this estimation

``` r
Cp<-function(i,est,size,data,included,sl){
  rem<-sapply(1:sl[1],saca,data=data,est=est,included=included,i=i)
  rem<-unlist(rem)
  Wprime<-est$coefficients[-rem]%*%ginv(est$var[-rem,-rem])%*%est$coefficients[-rem]
  Lambdaprime<-Wprime+2*length(est$coef[rem])
  Cp<-Lambdaprime-(length(est$coef)-1)
  c(Cp,included[,i])
  }
```

In the previous function we take into account that for factor variables we take out or include all the factors of a given variable, not one by one. The `saca` function checks all coefficients generated with a name from the included variables and includes all of them at the same time.

``` r
saca<-function(l,data,est,included,i){
   if (nlevels(data[,included[l,i]])==0) {included[l,i]
   }
   else {
     factores<-paste(names(data)[included[l,i]],levels(data[,included[l,i]]),
                     sep="")
     which(names(est$coef) %in% factores )
   }
 }
```

``` r
combinations<-function(k,size,est,data,nbest){
  included<-combn(1:size[2],k)
  sl<-dim(included)
  MCp<-sapply(1:sl[2],Cp,est=est,size=size,data=data,
                      included=included,sl=sl)
  MCp<-matrix(MCp,ncol=sl[2])
  best<-sort(MCp[1,],index.return=TRUE)
  cho<-min(nbest,size[2])
  MCp[,best$ix[1:cho]]
}
```

``` r
leapscox<-function(t,...) UseMethod("leapscox")

leapscox.default<-function(Survobj,data,nbest=5,...){
  est<-coxph(Survobj~.,data=data)
  size<-dim(data)
  nombres<-names(data)
  cpalpha<-sapply(1:(size[2]-1),combinations,size=size,est=est,data=data,
                  nbest=nbest) 
  #cpval<-lapply(cpalpha, `[`,1,)
  #bcp<- sort(unlist(cpval))[1:nbest]
  #chosen<-sapply(1:(size[2]-1), function(x) which( cpval[[x]] %in% bcp ))
  #suu<-sapply(1:(size[2]-1),function(x) cpalpha[[x]][,chosen[[x]]]) 
  #suu[lapply(suu,length)>0] 
}

### falta print, summary y print.summary
### Correr modelos escogidos en la funcion?
```

``` r
#require(emplik)

Myeloma<-read.csv2("Krall1975.csv",header=T)
X<-Myeloma[,grep("X",names(Myeloma))]
X<-subset(X,select=-X0)
attach(Myeloma)

aja1<-leapscox(Surv(t,A.D),data=X)
aja1
```

    ## [[1]]
    ##          [,1]     [,2]     [,3]     [,4]     [,5]
    ## [1,] 15.21678 16.55917 18.80322 19.65144 20.15759
    ## [2,]  1.00000  2.00000 13.00000 14.00000  3.00000
    ## 
    ## [[2]]
    ##          [,1]    [,2]     [,3]     [,4]     [,5]
    ## [1,] 13.06893 13.8873 15.20755 15.58005 15.85274
    ## [2,]  1.00000  1.0000  1.00000  1.00000  1.00000
    ## [3,]  2.00000 13.0000 14.00000  4.00000  5.00000
    ## 
    ## [[3]]
    ##          [,1]     [,2]     [,3]   [,4]     [,5]
    ## [1,] 12.33741 12.62307 12.76659 12.768 12.90548
    ## [2,]  1.00000  1.00000  1.00000  1.000  1.00000
    ## [3,]  2.00000  2.00000 13.00000  2.000  2.00000
    ## [4,] 14.00000 16.00000 14.00000 13.000  5.00000
    ## 
    ## [[4]]
    ##          [,1]     [,2]     [,3]     [,4]     [,5]
    ## [1,] 10.02739 10.66188 10.75026 10.96351 11.07049
    ## [2,]  1.00000  1.00000  1.00000  1.00000  1.00000
    ## [3,] 12.00000  3.00000  2.00000  3.00000  2.00000
    ## [4,] 13.00000 12.00000 14.00000  5.00000 13.00000
    ## [5,] 14.00000 13.00000 15.00000 13.00000 14.00000
    ## 
    ## [[5]]
    ##           [,1]     [,2]     [,3]      [,4]      [,5]
    ## [1,]  7.962501  8.67619  9.74013  9.800667  9.870303
    ## [2,]  1.000000  1.00000  1.00000  1.000000  1.000000
    ## [3,]  2.000000  3.00000  3.00000  4.000000  2.000000
    ## [4,] 12.000000  4.00000  7.00000 12.000000  4.000000
    ## [5,] 13.000000  5.00000 12.00000 13.000000  5.000000
    ## [6,] 14.000000 13.00000 13.00000 14.000000 16.000000
    ## 
    ## [[6]]
    ##           [,1]      [,2]      [,3]      [,4]      [,5]
    ## [1,]  7.604986  7.727917  7.943792  8.271356  8.481118
    ## [2,]  1.000000  1.000000  1.000000  1.000000  1.000000
    ## [3,]  2.000000  2.000000  2.000000  3.000000  3.000000
    ## [4,]  7.000000  4.000000  4.000000  4.000000  7.000000
    ## [5,] 12.000000 12.000000  5.000000  5.000000 12.000000
    ## [6,] 13.000000 13.000000 13.000000 12.000000 13.000000
    ## [7,] 14.000000 14.000000 16.000000 13.000000 14.000000
    ## 
    ## [[7]]
    ##          [,1]      [,2]      [,3]      [,4]      [,5]
    ## [1,]  7.18898  7.335751  7.629956  7.915085  7.952723
    ## [2,]  1.00000  1.000000  1.000000  1.000000  1.000000
    ## [3,]  3.00000  2.000000  3.000000  3.000000  2.000000
    ## [4,]  4.00000  4.000000  4.000000  4.000000  4.000000
    ## [5,]  6.00000  7.000000  7.000000  7.000000  8.000000
    ## [6,]  7.00000 12.000000 12.000000  8.000000 12.000000
    ## [7,] 12.00000 13.000000 13.000000 12.000000 13.000000
    ## [8,] 13.00000 14.000000 14.000000 13.000000 14.000000
    ## 
    ## [[8]]
    ##            [,1]      [,2]      [,3]     [,4]      [,5]
    ##  [1,]  5.532686  7.003275  7.036514  7.41747  7.613046
    ##  [2,]  1.000000  1.000000  1.000000  1.00000  1.000000
    ##  [3,]  3.000000  3.000000  2.000000  3.00000  3.000000
    ##  [4,]  4.000000  4.000000  4.000000  4.00000  4.000000
    ##  [5,]  6.000000  7.000000  7.000000  7.00000  6.000000
    ##  [6,]  7.000000  8.000000  8.000000 12.00000  7.000000
    ##  [7,]  8.000000 12.000000 12.000000 13.00000 12.000000
    ##  [8,] 12.000000 13.000000 13.000000 14.00000 13.000000
    ##  [9,] 13.000000 14.000000 14.000000 15.00000 14.000000
    ## 
    ## [[9]]
    ##            [,1]     [,2]      [,3]      [,4]      [,5]
    ##  [1,]  6.346075  6.59486  6.944637  7.009242  7.012903
    ##  [2,]  1.000000  1.00000  1.000000  1.000000  1.000000
    ##  [3,]  3.000000  2.00000  2.000000  3.000000  3.000000
    ##  [4,]  4.000000  3.00000  4.000000  4.000000  4.000000
    ##  [5,]  6.000000  4.00000  6.000000  6.000000  5.000000
    ##  [6,]  7.000000  6.00000  7.000000  7.000000  6.000000
    ##  [7,]  8.000000  7.00000  8.000000  8.000000  7.000000
    ##  [8,] 12.000000  8.00000 12.000000 10.000000  8.000000
    ##  [9,] 13.000000 12.00000 13.000000 12.000000 12.000000
    ## [10,] 14.000000 13.00000 14.000000 13.000000 13.000000
    ## 
    ## [[10]]
    ##           [,1]      [,2]      [,3]      [,4]      [,5]
    ##  [1,]  6.61947  7.064481  7.764905  7.998632  8.033414
    ##  [2,]  1.00000  1.000000  1.000000  1.000000  1.000000
    ##  [3,]  2.00000  3.000000  2.000000  3.000000  3.000000
    ##  [4,]  3.00000  4.000000  3.000000  4.000000  4.000000
    ##  [5,]  4.00000  6.000000  4.000000  5.000000  6.000000
    ##  [6,]  6.00000  7.000000  7.000000  6.000000  7.000000
    ##  [7,]  7.00000  8.000000  8.000000  7.000000  8.000000
    ##  [8,]  8.00000 12.000000 12.000000  8.000000 10.000000
    ##  [9,] 12.00000 13.000000 13.000000 12.000000 12.000000
    ## [10,] 13.00000 14.000000 14.000000 13.000000 13.000000
    ## [11,] 14.00000 15.000000 15.000000 14.000000 14.000000
    ## 
    ## [[11]]
    ##            [,1]      [,2]      [,3]      [,4]      [,5]
    ##  [1,]  7.370113  8.405193  8.551113  8.556086  8.601129
    ##  [2,]  1.000000  1.000000  1.000000  1.000000  1.000000
    ##  [3,]  2.000000  2.000000  2.000000  2.000000  2.000000
    ##  [4,]  3.000000  3.000000  3.000000  3.000000  3.000000
    ##  [5,]  4.000000  4.000000  4.000000  4.000000  4.000000
    ##  [6,]  6.000000  5.000000  6.000000  6.000000  6.000000
    ##  [7,]  7.000000  6.000000  7.000000  7.000000  7.000000
    ##  [8,]  8.000000  7.000000  8.000000  8.000000  8.000000
    ##  [9,] 12.000000  8.000000  9.000000 10.000000 11.000000
    ## [10,] 13.000000 12.000000 12.000000 12.000000 12.000000
    ## [11,] 14.000000 13.000000 13.000000 13.000000 13.000000
    ## [12,] 15.000000 14.000000 14.000000 14.000000 14.000000
    ## 
    ## [[12]]
    ##            [,1]      [,2]      [,3]      [,4]     [,5]
    ##  [1,]  9.172323  9.265134  9.288571  9.328967  9.36994
    ##  [2,]  1.000000  1.000000  1.000000  1.000000  1.00000
    ##  [3,]  2.000000  2.000000  2.000000  2.000000  2.00000
    ##  [4,]  3.000000  3.000000  3.000000  3.000000  3.00000
    ##  [5,]  4.000000  4.000000  4.000000  4.000000  4.00000
    ##  [6,]  5.000000  6.000000  6.000000  6.000000  6.00000
    ##  [7,]  6.000000  7.000000  7.000000  7.000000  7.00000
    ##  [8,]  7.000000  8.000000  8.000000  8.000000  8.00000
    ##  [9,]  8.000000 10.000000 12.000000  9.000000 11.00000
    ## [10,] 12.000000 12.000000 13.000000 12.000000 12.00000
    ## [11,] 13.000000 13.000000 14.000000 13.000000 13.00000
    ## [12,] 14.000000 14.000000 15.000000 14.000000 14.00000
    ## [13,] 15.000000 15.000000 16.000000 15.000000 15.00000
    ## 
    ## [[13]]
    ##           [,1]     [,2]    [,3]     [,4]     [,5]
    ##  [1,] 11.09159 11.11257 11.1528 11.15915 11.17232
    ##  [2,]  1.00000  1.00000  1.0000  1.00000  1.00000
    ##  [3,]  2.00000  2.00000  2.0000  2.00000  2.00000
    ##  [4,]  3.00000  3.00000  3.0000  3.00000  3.00000
    ##  [5,]  4.00000  4.00000  4.0000  4.00000  4.00000
    ##  [6,]  6.00000  5.00000  5.0000  5.00000  5.00000
    ##  [7,]  7.00000  6.00000  6.0000  6.00000  6.00000
    ##  [8,]  8.00000  7.00000  7.0000  7.00000  7.00000
    ##  [9,]  9.00000  8.00000  8.0000  8.00000  8.00000
    ## [10,] 10.00000 10.00000 12.0000  9.00000 11.00000
    ## [11,] 12.00000 12.00000 13.0000 12.00000 12.00000
    ## [12,] 13.00000 13.00000 14.0000 13.00000 13.00000
    ## [13,] 14.00000 14.00000 15.0000 14.00000 14.00000
    ## [14,] 15.00000 15.00000 16.0000 15.00000 15.00000
    ## 
    ## [[14]]
    ##           [,1]     [,2]     [,3]     [,4]     [,5]
    ##  [1,] 13.02274 13.03753 13.07739 13.08776 13.10039
    ##  [2,]  1.00000  1.00000  1.00000  1.00000  1.00000
    ##  [3,]  2.00000  2.00000  2.00000  2.00000  2.00000
    ##  [4,]  3.00000  3.00000  3.00000  3.00000  3.00000
    ##  [5,]  4.00000  4.00000  4.00000  4.00000  4.00000
    ##  [6,]  5.00000  6.00000  5.00000  6.00000  5.00000
    ##  [7,]  6.00000  7.00000  6.00000  7.00000  6.00000
    ##  [8,]  7.00000  8.00000  7.00000  8.00000  7.00000
    ##  [9,]  8.00000  9.00000  8.00000  9.00000  8.00000
    ## [10,]  9.00000 10.00000 10.00000 10.00000 10.00000
    ## [11,] 10.00000 12.00000 11.00000 11.00000 12.00000
    ## [12,] 12.00000 13.00000 12.00000 12.00000 13.00000
    ## [13,] 13.00000 14.00000 13.00000 13.00000 14.00000
    ## [14,] 14.00000 15.00000 14.00000 14.00000 15.00000
    ## [15,] 15.00000 16.00000 15.00000 15.00000 16.00000
    ## 
    ## [[15]]
    ##           [,1]     [,2]     [,3]    [,4]     [,5]
    ##  [1,] 15.00001 15.02155 15.03753 15.0496 15.11857
    ##  [2,]  1.00000  1.00000  1.00000  1.0000  1.00000
    ##  [3,]  2.00000  2.00000  2.00000  2.0000  2.00000
    ##  [4,]  3.00000  3.00000  3.00000  3.0000  3.00000
    ##  [5,]  4.00000  4.00000  4.00000  4.0000  4.00000
    ##  [6,]  5.00000  5.00000  6.00000  5.0000  5.00000
    ##  [7,]  6.00000  6.00000  7.00000  6.0000  6.00000
    ##  [8,]  7.00000  7.00000  8.00000  7.0000  7.00000
    ##  [9,]  8.00000  8.00000  9.00000  8.0000  8.00000
    ## [10,]  9.00000  9.00000 10.00000 10.0000  9.00000
    ## [11,] 10.00000 10.00000 11.00000 11.0000 11.00000
    ## [12,] 12.00000 11.00000 12.00000 12.0000 12.00000
    ## [13,] 13.00000 12.00000 13.00000 13.0000 13.00000
    ## [14,] 14.00000 13.00000 14.00000 14.0000 14.00000
    ## [15,] 15.00000 14.00000 15.00000 15.0000 15.00000
    ## [16,] 16.00000 15.00000 16.00000 16.0000 16.00000

``` r
# ames(x1)[c(3.00000,4.00000,5.00000,6.00000,  7.00000,  8.00000, 10.00000)]
## [9] 11.00000
# 
# bb<-coxph(Surv(t,A.D)~.,data=X)
# bb2<-coxph(Surv(t,A.D)~X1+X3+X4+X6+X7+X8+X12+X13,data=X)
# 
# 2*(bb$loglik[2]-bb2$loglik[2])+2*8-15
```

Results differ from Kuk 1984, I have two hypothesis for this, either, due to advances in software, i.e., loglik for models is different. Or, I messed up inputing the data from Krall, et al 1975.

*falta: y~. no incluye ninguna variable y~x siempre incluye x* *Education eliminada porque da INF.*
